(function(h){function f(a){Pablo.extend(this,a);this.createElements().setText(a.title).setPosition(a.dx,a.dy)}function g(a){this.create(a)}f.prototype={PADDING_X:6,PADDING_Y:4,CORNER_R:7,PATH_CURVE:30,FONTSIZE:20,createElements:function(){this.dom=this.parent.dom.g().addClass("node").data("node",this);this.dom.rect({rx:this.CORNER_R});this.dom.text({x:this.PADDING_X,y:this.FONTSIZE,"font-size":this.FONTSIZE});this.parent.id&&(this.path=Pablo.path().prependTo(this.parent.dom));return this},setText:function(a){a=
this.dom.children("text").content(a)[0].getBBox();this.width=a.width+2*this.PADDING_X;this.height=a.height+this.PADDING_Y;this.dom.children("rect").attr({width:this.width,height:this.height});return this.setPath()},setPosition:function(a,b){this.dx=a;this.dy=b;this.dom.transform("translate",a,b);return this.setPath()},setPath:function(){this.path&&this.path.attr("d",this.getPathData());return this},getPathData:function(){var a=0>this.dx+this.width/2,b=a?0:this.parent.width,c=this.dx+(a?this.width:
-b),e=this.dy,d=this.PATH_CURVE;return"m"+b+" "+this.parent.height/2+"q"+(c/2+(a?d:-d))+" "+(e/2+(0>this.dy+this.height/2?-d:d))+","+c+" "+e},dragStart:function(a,b){this.dragOffsetX=a-this.dx;this.dragOffsetY=b-this.dy;return this},drag:function(a,b){return this.setPosition(a-this.dragOffsetX,b-this.dragOffsetY)}};g.prototype={nextId:1,create:function(a){this.svg=Pablo(a).empty().svg();this.rootNode={id:0,dx:0,dy:0,dom:this.svg};this.nodes=[];return this.setupEvents().makeSelected(this.rootNode)},
setupEvents:function(){var a=this;this.svg.on("mousedown",".node text, .node rect",function(b){var c,e,d;1===b.which&&(c=Pablo(b.target).parent().data("node"),a.makeSelected(c),c.dragStart(b.pageX,b.pageY),e=function(a){c.drag(a.pageX,a.pageY)},d=function(b){if("mouseout"===b.type&&((b=b.relatedTarget)&&b===this||b.ownerSVGElement===this))return;a.svg.off("mousemove",e).off("mousup mouseout",d)},a.svg.on("mousemove",e).on("mouseup mouseout",d),b.stopPropagation())},!0).on("mousedown",function(b){1===
b.which&&a.nodes.length&&a.makeSelected(a.nodes[0])});return this},createNode:function(a,b){var c;a.id||(a.id=this.nextId++);a.parent||(a.parent=this.selected);if(b)for(c=a.parent;c;)a.dx-=c.dx,a.dy-=c.dy,c=c.parent;c=new f(a);this.nodes.push(c);this.selected.dom===this.svg&&this.makeSelected(c);return this},makeSelected:function(a){this.selected&&this.selected.dom.removeClass("selected");this.selected=a;a.dom.addClass("selected").appendTo(a.dom.parent());return this}};h.MindMap=g})(this);